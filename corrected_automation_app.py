"""
ÏàòÏ†ïÎêú Action Tracker ÏûêÎèôÌôî Ïï±
Ïò¨Î∞îÎ•∏ Ï¢åÌëúÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Îê®
"""

import tkinter as tk
from tkinter import ttk, messagebox, scrolledtext
import pyautogui
import time
import threading
from datetime import datetime

class CorrectedActionTrackerApp:
    def __init__(self):
        """Ïï± Ï¥àÍ∏∞Ìôî"""
        self.root = tk.Tk()
        self.root.title("Corrected Action Tracker Automation v1.1")
        self.root.geometry("800x600")
        self.root.configure(bg='#2b2b2b')
        
        # ÏàòÏ†ïÎêú Ï¢åÌëú Ï†ïÎ≥¥ (Ïä§ÌÅ¨Î¶∞ÏÉ∑ Î∂ÑÏÑù Í∏∞Î∞ò)
        self.coordinates = {
            'alice': (150, 260),          # Alice Î≤ÑÌäº (Ï≤´ Î≤àÏß∏ ÌîåÎ†àÏù¥Ïñ¥)
            'player2': (275, 260),        # Player2 Î≤ÑÌäº
            'player3': (393, 260),        # Player3 Î≤ÑÌäº
            'edit_field': (400, 300),     # Ìé∏Ïßë ÌïÑÎìú (Ï∂îÏ†ï)
            'settings': (867, 785),       # Settings Î≤ÑÌäº
            'go_button': (1127, 750)      # GO Î≤ÑÌäº
        }
        
        # Ïã§Ìñâ ÏÉÅÌÉú
        self.is_running = False
        
        self.setup_ui()
        
    def setup_ui(self):
        """UI Íµ¨ÏÑ±"""
        # Î©îÏù∏ ÌîÑÎ†àÏûÑ
        main_frame = tk.Frame(self.root, bg='#2b2b2b')
        main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # Ï†úÎ™©
        title_label = tk.Label(
            main_frame,
            text="üîß Corrected Action Tracker Automation",
            font=("Arial", 18, "bold"),
            bg='#2b2b2b',
            fg='#ffffff'
        )
        title_label.pack(pady=(0, 20))
        
        # Ï¢åÏ∏° Ìå®ÎÑê (Ïª®Ìä∏Î°§)
        left_frame = tk.Frame(main_frame, bg='#3c3c3c', relief=tk.RAISED, bd=2)
        left_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=False, padx=(0, 10))
        
        # Ïö∞Ï∏° Ìå®ÎÑê (Î°úÍ∑∏)
        right_frame = tk.Frame(main_frame, bg='#3c3c3c', relief=tk.RAISED, bd=2)
        right_frame.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True, padx=(10, 0))
        
        self.setup_control_panel(left_frame)
        self.setup_log_panel(right_frame)
        
    def setup_control_panel(self, parent):
        """Ïª®Ìä∏Î°§ Ìå®ÎÑê Íµ¨ÏÑ±"""
        # Ïª®Ìä∏Î°§ Ìå®ÎÑê Ï†úÎ™©
        control_title = tk.Label(
            parent,
            text="üéØ Player Controls (Corrected)",
            font=("Arial", 14, "bold"),
            bg='#3c3c3c',
            fg='#ffffff'
        )
        control_title.pack(pady=10)
        
        # Alice Ï°∞Ïûë ÏÑπÏÖò
        alice_frame = tk.LabelFrame(
            parent,
            text="Alice Player Control",
            font=("Arial", 10, "bold"),
            bg='#3c3c3c',
            fg='#ffffff',
            bd=2,
            relief=tk.GROOVE
        )
        alice_frame.pack(fill=tk.X, padx=10, pady=5)
        
        # Ïù¥Î¶Ñ ÏûÖÎ†•
        tk.Label(
            alice_frame,
            text="New Name:",
            bg='#3c3c3c',
            fg='#ffffff'
        ).pack(anchor=tk.W, padx=5, pady=(5, 0))
        
        self.name_entry = tk.Entry(
            alice_frame,
            font=("Arial", 12),
            width=20
        )
        self.name_entry.pack(fill=tk.X, padx=5, pady=5)
        
        # Alice Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Î≤ÑÌäº
        self.alice_update_button = tk.Button(
            alice_frame,
            text="‚ö° Update Alice Name",
            command=self.update_alice_name,
            bg='#4CAF50',
            fg='white',
            font=("Arial", 10, "bold"),
            relief=tk.RAISED,
            bd=2
        )
        self.alice_update_button.pack(fill=tk.X, padx=5, pady=5)
        
        # Îπ†Î•∏ Ïù¥Î¶Ñ Î≤ÑÌäºÎì§
        quick_frame = tk.LabelFrame(
            parent,
            text="Quick Names for Alice",
            font=("Arial", 10, "bold"),
            bg='#3c3c3c',
            fg='#ffffff',
            bd=2,
            relief=tk.GROOVE
        )
        quick_frame.pack(fill=tk.X, padx=10, pady=5)
        
        quick_names = ["Mike", "Bob", "Charlie", "Diana", "Eve", "Frank"]
        for i, name in enumerate(quick_names):
            if i % 2 == 0:
                row_frame = tk.Frame(quick_frame, bg='#3c3c3c')
                row_frame.pack(fill=tk.X, padx=5, pady=2)
            
            btn = tk.Button(
                row_frame,
                text=name,
                command=lambda n=name: self.quick_name_update(n),
                bg='#2196F3',
                fg='white',
                font=("Arial", 9),
                width=8
            )
            btn.pack(side=tk.LEFT, padx=2)
        
        # ÌÖåÏä§Ìä∏ ÏÑπÏÖò
        test_frame = tk.LabelFrame(
            parent,
            text="Testing",
            font=("Arial", 10, "bold"),
            bg='#3c3c3c',
            fg='#ffffff',
            bd=2,
            relief=tk.GROOVE
        )
        test_frame.pack(fill=tk.X, padx=10, pady=5)
        
        self.test_click_button = tk.Button(
            test_frame,
            text="üéØ Test Alice Click",
            command=self.test_alice_click,
            bg='#ff9800',
            fg='white',
            font=("Arial", 10, "bold"),
            relief=tk.RAISED,
            bd=2
        )
        self.test_click_button.pack(fill=tk.X, padx=5, pady=5)
        
        # Ï¢åÌëú Ï†ïÎ≥¥
        coords_frame = tk.LabelFrame(
            parent,
            text="Corrected Coordinates",
            font=("Arial", 10, "bold"),
            bg='#3c3c3c',
            fg='#ffffff',
            bd=2,
            relief=tk.GROOVE
        )
        coords_frame.pack(fill=tk.X, padx=10, pady=5)
        
        coords_text = tk.Text(
            coords_frame,
            height=5,
            width=25,
            font=("Consolas", 9),
            bg='#1e1e1e',
            fg='#00ff00'
        )
        coords_text.pack(padx=5, pady=5)
        
        coords_info = f"""Alice: ({self.coordinates['alice'][0]}, {self.coordinates['alice'][1]})
Player2: ({self.coordinates['player2'][0]}, {self.coordinates['player2'][1]})  
Player3: ({self.coordinates['player3'][0]}, {self.coordinates['player3'][1]})
Settings: ({self.coordinates['settings'][0]}, {self.coordinates['settings'][1]})
Status: Corrected"""
        coords_text.insert(tk.END, coords_info)
        coords_text.config(state=tk.DISABLED)
        
    def setup_log_panel(self, parent):
        """Î°úÍ∑∏ Ìå®ÎÑê Íµ¨ÏÑ±"""
        # Î°úÍ∑∏ Ìå®ÎÑê Ï†úÎ™©
        log_title = tk.Label(
            parent,
            text="üìã Activity Log (Corrected Version)",
            font=("Arial", 14, "bold"),
            bg='#3c3c3c',
            fg='#ffffff'
        )
        log_title.pack(pady=10)
        
        # Î°úÍ∑∏ ÌÖçÏä§Ìä∏ ÏòÅÏó≠
        self.log_text = scrolledtext.ScrolledText(
            parent,
            font=("Consolas", 10),
            bg='#1e1e1e',
            fg='#00ff00',
            insertbackground='#00ff00',
            selectbackground='#404040'
        )
        self.log_text.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # Ï¥àÍ∏∞ Î°úÍ∑∏ Î©îÏãúÏßÄ
        self.add_log("=== Corrected Action Tracker Automation Started ===")
        self.add_log("Coordinates updated based on screenshot analysis")
        self.add_log("Ready for testing")
        
        # Î°úÍ∑∏ Ï†úÏñ¥ Î≤ÑÌäº
        log_control_frame = tk.Frame(parent, bg='#3c3c3c')
        log_control_frame.pack(fill=tk.X, padx=10, pady=(0, 10))
        
        clear_log_btn = tk.Button(
            log_control_frame,
            text="Clear Log",
            command=self.clear_log,
            bg='#ff9800',
            fg='white',
            font=("Arial", 9)
        )
        clear_log_btn.pack(side=tk.RIGHT)
        
    def add_log(self, message):
        """Î°úÍ∑∏ Ï∂îÍ∞Ä"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        log_entry = f"[{timestamp}] {message}\n"
        
        self.log_text.insert(tk.END, log_entry)
        self.log_text.see(tk.END)
        self.root.update()
        
    def clear_log(self):
        """Î°úÍ∑∏ ÏßÄÏö∞Í∏∞"""
        self.log_text.delete(1.0, tk.END)
        self.add_log("Log cleared")
    
    def test_alice_click(self):
        """Alice Î≤ÑÌäº ÌÅ¥Î¶≠ ÌÖåÏä§Ìä∏"""
        if self.is_running:
            messagebox.showwarning("Warning", "Already running an operation!")
            return
            
        self.run_in_thread(lambda: self.perform_test_click())
    
    def perform_test_click(self):
        """ÌÖåÏä§Ìä∏ ÌÅ¥Î¶≠ ÏàòÌñâ"""
        try:
            self.add_log("Testing Alice button click...")
            alice_x, alice_y = self.coordinates['alice']
            
            self.add_log(f"Clicking Alice at ({alice_x}, {alice_y})")
            pyautogui.click(alice_x, alice_y)
            time.sleep(0.5)
            
            self.add_log("Test click completed!")
            self.add_log("Check if Alice was selected/highlighted")
            
        except Exception as e:
            self.add_log(f"Test click failed: {str(e)}")
    
    def update_alice_name(self):
        """Alice Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏"""
        if self.is_running:
            messagebox.showwarning("Warning", "Already running an operation!")
            return
            
        name = self.name_entry.get().strip()
        if not name:
            messagebox.showwarning("Warning", "Please enter a name!")
            return
        
        self.run_in_thread(lambda: self.perform_name_update(name))
    
    def quick_name_update(self, name):
        """Îπ†Î•∏ Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏"""
        if self.is_running:
            messagebox.showwarning("Warning", "Already running an operation!")
            return
            
        self.run_in_thread(lambda: self.perform_name_update(name))
    
    def perform_name_update(self, name):
        """Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏàòÌñâ"""
        try:
            self.add_log(f"Starting name update: Alice -> {name}")
            start_time = time.time()
            
            # 1Îã®Í≥Ñ: Alice ÌÅ¥Î¶≠
            self.add_log("Step 1: Clicking Alice...")
            alice_x, alice_y = self.coordinates['alice']
            pyautogui.click(alice_x, alice_y)
            time.sleep(0.4)
            
            # 2Îã®Í≥Ñ: Ïù¥Î¶Ñ ÏûÖÎ†• (ÏßÅÏ†ë ÌÉÄÏù¥Ìïë)
            self.add_log(f"Step 2: Typing '{name}'...")
            pyautogui.typewrite(name)
            time.sleep(0.2)
            
            # 3Îã®Í≥Ñ: Enter ÌÇ§
            self.add_log("Step 3: Pressing Enter...")
            pyautogui.press('enter')
            time.sleep(0.3)
            
            elapsed = time.time() - start_time
            self.add_log(f"SUCCESS: {name} updated in {elapsed:.1f}s")
            self.add_log("=" * 40)
            
            return True
            
        except Exception as e:
            self.add_log(f"ERROR: {str(e)}")
            return False
    
    def run_in_thread(self, func):
        """Î≥ÑÎèÑ Ïä§Î†àÎìúÏóêÏÑú Ïã§Ìñâ"""
        self.is_running = True
        self.update_button_states(False)
        
        def wrapper():
            try:
                func()
            finally:
                self.is_running = False
                self.root.after(0, lambda: self.update_button_states(True))
        
        thread = threading.Thread(target=wrapper)
        thread.daemon = True
        thread.start()
    
    def update_button_states(self, enabled):
        """Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏"""
        state = tk.NORMAL if enabled else tk.DISABLED
        self.alice_update_button.config(state=state)
        self.test_click_button.config(state=state)
    
    def run(self):
        """Ïï± Ïã§Ìñâ"""
        # Ï∞Ω Ï§ëÏïô Ï†ïÎ†¨
        self.root.update_idletasks()
        width = self.root.winfo_width()
        height = self.root.winfo_height()
        x = (self.root.winfo_screenwidth() // 2) - (width // 2)
        y = (self.root.winfo_screenheight() // 2) - (height // 2)
        self.root.geometry(f"{width}x{height}+{x}+{y}")
        
        # Ï¢ÖÎ£å Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)
        
        self.add_log("Corrected app ready! Test Alice button first.")
        self.root.mainloop()
    
    def on_closing(self):
        """Ïï± Ï¢ÖÎ£å Ïãú"""
        if self.is_running:
            if messagebox.askokcancel("Quit", "Operation in progress. Force quit?"):
                self.root.destroy()
        else:
            self.root.destroy()

def main():
    """Î©îÏù∏ Ïã§Ìñâ"""
    try:
        app = CorrectedActionTrackerApp()
        app.run()
    except Exception as e:
        messagebox.showerror("Error", f"Application error: {str(e)}")

if __name__ == "__main__":
    main()